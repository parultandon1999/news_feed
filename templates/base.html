<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Security Intelligence Platform{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=12.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="sidebar-layout">
    <!-- Sophisticated Sidebar -->
    <aside class="app-sidebar">
        <div class="sidebar-header">
            <a href="/" class="sidebar-logo">
                <div class="logo-box">
                    <i data-lucide="shield-check" style="width: 18px; height: 18px;"></i>
                </div>
                <div class="logo-text">SECINTEL</div>
            </a>
        </div>
        
        <nav class="sidebar-nav">
            <a href="/" class="sidebar-nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}">
                <i data-lucide="layout-dashboard" style="width: 18px;"></i>
                <span>Intelligence</span>
            </a>
            <a href="/news" class="sidebar-nav-link {% if request.endpoint == 'news' %}active{% endif %}">
                <i data-lucide="newspaper" style="width: 18px;"></i>
                <span>News Monitor</span>
            </a>
            <a href="/cve" class="sidebar-nav-link {% if request.endpoint == 'cve' %}active{% endif %}">
                <i data-lucide="shield-alert" style="width: 18px;"></i>
                <span>Vulnerabilities</span>
            </a>
            <a href="/ransomware" class="sidebar-nav-link {% if request.endpoint == 'ransomware' %}active{% endif %}">
                <i data-lucide="lock" style="width: 18px;"></i>
                <span>Ransomware</span>
            </a>
            <a href="/government" class="sidebar-nav-link {% if request.endpoint == 'government' %}active{% endif %}">
                <i data-lucide="building-2" style="width: 18px;"></i>
                <span>Advisories</span>
            </a>
            <a href="/tasks" class="sidebar-nav-link {% if request.endpoint == 'tasks' %}active{% endif %}">
                <i data-lucide="list-checks" style="width: 18px;"></i>
                <span>Operations</span>
            </a>
            <a href="/settings" class="sidebar-nav-link {% if request.endpoint == 'settings' %}active{% endif %}">
                <i data-lucide="settings-2" style="width: 18px;"></i>
                <span>System</span>
            </a>
        </nav>
        
        <div style="padding: 24px; border-top: 1px solid var(--border);">
            <div id="themeToggle" style="display: flex; align-items: center; gap: 12px; cursor: pointer; color: var(--text-muted); font-size: 12px; font-weight: 600;">
                <i data-lucide="moon" style="width: 16px;"></i>
                <span>Switch Profile</span>
            </div>
        </div>
    </aside>

    <!-- Content Area -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Notification System -->
    <div id="notificationContainer" style="position: fixed; top: 32px; right: 32px; z-index: 10000; display: flex; flex-direction: column; gap: 12px;"></div>

    <script>
    // Initialize Icons
    lucide.createIcons();

    // Notification Engine
    function showNotification(message, type = 'info') {
        const container = document.getElementById('notificationContainer');
        const note = document.createElement('div');
        note.style.background = 'var(--bg-card)';
        note.style.border = '1px solid var(--border)';
        note.style.padding = '12px 20px';
        note.style.borderRadius = '8px';
        note.style.color = 'var(--text-primary)';
        note.style.fontSize = '13px';
        note.style.fontWeight = '600';
        note.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
        note.style.borderLeft = `4px solid ${type === 'error' ? 'var(--severity-critical)' : 'var(--accent-primary)'}`;
        note.textContent = message;
        
        container.appendChild(note);
        setTimeout(() => {
            note.style.opacity = '0';
            setTimeout(() => note.remove(), 500);
        }, 4000);
    }

    // Theme Logic
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('click', () => {
        const html = document.documentElement;
        const current = html.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
    });

    if (localStorage.getItem('theme')) {
        document.documentElement.setAttribute('data-theme', localStorage.getItem('theme'));
    }

    // External Link Warning Dialog
    function showExternalLinkWarning(url, sourceName = 'external website') {
        return new Promise((resolve) => {
            // Create modal backdrop
            const backdrop = document.createElement('div');
            backdrop.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(4px);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.2s ease-out;
            `;

            // Create modal dialog
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-primary);
                border: 2px solid var(--border);
                border-radius: var(--radius-lg);
                padding: var(--space-xl);
                max-width: 500px;
                width: 90%;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease-out;
                position: relative;
            `;

            // Extract domain from URL for display
            let displayDomain = url;
            try {
                const urlObj = new URL(url);
                displayDomain = urlObj.hostname;
            } catch (e) {
                displayDomain = url.replace(/^https?:\/\//, '').split('/')[0];
            }

            modal.innerHTML = `
                <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-lg);">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i data-lucide="external-link" style="width: 24px; height: 24px; color: white;"></i>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: var(--fs-lg); font-weight: var(--fw-bold); color: var(--text-primary);">External Website Warning</h3>
                        <p style="margin: 4px 0 0 0; font-size: var(--fs-sm); color: var(--text-secondary);">You're about to leave our secure platform</p>
                    </div>
                </div>

                <div style="background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: var(--space-lg); margin-bottom: var(--space-lg);">
                    <p style="margin: 0 0 var(--space-md) 0; font-size: var(--fs-base); color: var(--text-primary); line-height: 1.6;">
                        You're about to visit <strong>${sourceName}</strong> at:
                    </p>
                    <div style="background: var(--bg-primary); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: var(--space-md); font-family: var(--font-mono); font-size: var(--fs-sm); color: var(--accent-primary); word-break: break-all; margin-bottom: var(--space-md);">
                        ${displayDomain}
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: var(--space-sm); padding: var(--space-md); background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: var(--radius-sm);">
                        <i data-lucide="alert-triangle" style="width: 20px; height: 20px; color: var(--severity-high); flex-shrink: 0; margin-top: 2px;"></i>
                        <div style="font-size: var(--fs-sm); color: var(--text-primary); line-height: 1.5;">
                            <strong>Security Notice:</strong> This link leads to an external website. Please verify the URL and ensure you trust the source before proceeding.
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: var(--space-md); justify-content: flex-end;">
                    <button id="cancelBtn" style="padding: 12px 24px; background: var(--bg-elevated); color: var(--text-primary); border: 2px solid var(--border); border-radius: var(--radius-md); font-weight: var(--fw-semibold); cursor: pointer; transition: all 0.2s;">
                        Cancel
                    </button>
                    <button id="proceedBtn" style="padding: 12px 24px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; border-radius: var(--radius-md); font-weight: var(--fw-bold); cursor: pointer; transition: all 0.2s;">
                        Continue to Website
                    </button>
                </div>
            `;

            backdrop.appendChild(modal);
            document.body.appendChild(backdrop);

            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Add CSS animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideIn {
                    from { transform: translateY(-20px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            // Event handlers
            const cleanup = () => {
                document.body.removeChild(backdrop);
                document.head.removeChild(style);
            };

            document.getElementById('cancelBtn').onclick = () => {
                cleanup();
                resolve(false);
            };

            document.getElementById('proceedBtn').onclick = () => {
                cleanup();
                resolve(true);
            };

            // Close on backdrop click
            backdrop.onclick = (e) => {
                if (e.target === backdrop) {
                    cleanup();
                    resolve(false);
                }
            };

            // Close on Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    cleanup();
                    document.removeEventListener('keydown', handleEscape);
                    resolve(false);
                }
            };
            document.addEventListener('keydown', handleEscape);
        });
    }

    // Safe external link function
    async function openExternalLink(url, sourceName = 'external website') {
        if (!url || url === '#') return false;
        
        const shouldProceed = await showExternalLinkWarning(url, sourceName);
        if (shouldProceed) {
            window.open(url, '_blank', 'noopener,noreferrer');
        }
        return shouldProceed;
    }
    </script>
</body>
</html>
