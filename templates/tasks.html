{% extends "base.html" %}

{% block title %}Operations Center{% endblock %}

{% block content %}
<div class="main-content-wrapper">
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Advisory Operations Center</h1>
            <p class="dashboard-subtitle">Manage security advisories and client distribution.</p>
        </div>
    </header>

    <!-- Create Advisory -->
    <div style="background: var(--bg-card); border: 2px solid var(--border); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 32px;">
        <h2 style="font-size: 15px; font-weight: 800; margin-bottom: 16px; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.05em;">CREATE NEW ADVISORY</h2>
        <form id="advisoryForm" style="display: grid; grid-template-columns: 1fr 2fr 1fr auto; gap: 12px; align-items: end;">
            <div>
                <label style="display: block; font-size: 10px; font-weight: 800; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase;">Name</label>
                <input type="text" id="advisoryName" class="pro-input" placeholder="Advisory identifier" required style="padding: 10px 14px;">
            </div>
            <div>
                <label style="display: block; font-size: 10px; font-weight: 800; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase;">Topic</label>
                <input type="text" id="advisoryTopic" class="pro-input" placeholder="Brief description" required style="padding: 10px 14px;">
            </div>
            <div>
                <label style="display: block; font-size: 10px; font-weight: 800; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase;">Date</label>
                <input type="date" id="advisorySentDate" class="pro-input" required style="padding: 10px 14px;">
            </div>
            <button type="submit" class="intel-btn" style="padding: 10px 24px; font-size: 12px;">CREATE</button>
        </form>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        <!-- Pending Advisories -->
        <div>
            <h2 style="font-size: 16px; font-weight: 800; margin-bottom: 20px; color: var(--text-primary);">PENDING ({{ advisories_pending|length }})</h2>
            
            {% if advisories_pending %}
                {% for advisory in advisories_pending %}
                <div style="background: var(--bg-card); border: 2px solid var(--border); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                        <div style="flex: 1;">
                            <h3 style="font-size: 16px; font-weight: 800; color: var(--text-primary); margin-bottom: 6px;">{{ advisory.name }}</h3>
                            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">{{ advisory.topic }}</p>
                            <p style="font-size: 11px; color: var(--text-muted);">{{ advisory.sent_date }}</p>
                        </div>
                        <button onclick="deleteAdvisory({{ advisory.id }})" class="intel-btn danger" style="padding: var(--space-sm) var(--space-md); font-size: var(--fs-xs);">DELETE</button>
                    </div>
                    
                    <div style="border-top: 2px solid var(--border); padding-top: 16px;">
                        <button onclick="toggleClients({{ advisory.id }})" class="intel-btn" style="width: 100%; padding: var(--space-md); font-size: var(--fs-xs); margin-bottom: var(--space-md); background: var(--bg-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary); display: flex; align-items: center; justify-content: center; gap: var(--space-sm);">
                            <i data-lucide="users" style="width: 14px; height: 14px;"></i>
                            <span>SELECT CLIENTS</span>
                            <i data-lucide="chevron-down" id="chevron-{{ advisory.id }}" style="width: 14px; height: 14px; transition: transform 0.3s;"></i>
                        </button>
                        <div id="clients-{{ advisory.id }}" style="display: none; margin-bottom: 12px;">
                            <div style="display: flex; flex-direction: column; gap: 6px; max-height: 300px; overflow-y: auto; padding: 8px; background: var(--bg-elevated); border-radius: var(--radius-md);">
                                {% for client in clients %}
                                <label style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-app); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;" class="client-check-label">
                                    <input type="checkbox" 
                                           class="client-checkbox-{{ advisory.id }}" 
                                           data-client-id="{{ client.id }}"
                                           value="{{ client.id }}"
                                           {% if client.id in (advisory.clients|map(attribute='id')|list) %}checked{% endif %}
                                           style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent-primary);">
                                    <span style="font-size: 12px; font-weight: 700; color: var(--text-primary);">{{ client.name }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        <button onclick="saveAndSend({{ advisory.id }})" class="intel-btn" style="width: 100%; padding: 10px; font-size: 12px;">SAVE & SEND</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="padding: 40px; text-align: center; background: var(--bg-card); border: 2px dashed var(--border); border-radius: var(--radius-lg); color: var(--text-muted);">No pending advisories</div>
            {% endif %}
        </div>

        <!-- Sent Advisories -->
        <div>
            <h2 style="font-size: 16px; font-weight: 800; margin-bottom: 20px; color: var(--text-primary);">SENT ({{ advisories_sent|length }})</h2>
            
            {% if advisories_sent %}
                {% for advisory in advisories_sent %}
                <div style="background: var(--bg-card); border: 2px solid var(--border); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                        <div style="flex: 1;">
                            <h3 style="font-size: 16px; font-weight: 800; color: var(--text-primary); margin-bottom: 6px;">{{ advisory.name }}</h3>
                            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">{{ advisory.topic }}</p>
                            <p style="font-size: 11px; color: var(--text-muted);">Sent: {{ advisory.sent_date }}</p>
                            <div style="margin-top: 8px;">
                                <p style="font-size: 11px; color: var(--accent-primary); font-weight: 700; margin-bottom: 6px;">
                                    <i data-lucide="users" style="width: 12px; height: 12px; display: inline-block; vertical-align: middle;"></i>
                                    {{ (advisory.clients|map(attribute='id')|list)|length }} Recipient(s)
                                </p>
                                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px;">
                                    {% for client in advisory.clients %}
                                    <span style="padding: 4px 10px; background: rgba(20, 184, 166, 0.15); border: 1px solid var(--accent-primary); border-radius: 6px; font-size: 10px; font-weight: 700; color: var(--accent-primary);">{{ client.name }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteAdvisory({{ advisory.id }})" class="intel-btn danger" style="padding: var(--space-sm) var(--space-md); font-size: var(--fs-xs);">DELETE</button>
                    </div>
                    
                    <div style="border-top: 2px solid var(--border); padding-top: 16px;">
                        <button onclick="toggleClients({{ advisory.id }})" class="intel-btn" style="width: 100%; padding: var(--space-md); font-size: var(--fs-xs); margin-bottom: var(--space-md); background: var(--bg-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary); display: flex; align-items: center; justify-content: center; gap: var(--space-sm);">
                            <i data-lucide="edit" style="width: 14px; height: 14px;"></i>
                            <span>MODIFY CLIENTS</span>
                            <i data-lucide="chevron-down" id="chevron-{{ advisory.id }}" style="width: 14px; height: 14px; transition: transform 0.3s;"></i>
                        </button>
                        <div id="clients-{{ advisory.id }}" style="display: none; margin-bottom: 12px;">
                            <div style="display: flex; flex-direction: column; gap: 6px; max-height: 300px; overflow-y: auto; padding: 8px; background: var(--bg-elevated); border-radius: var(--radius-md);">
                                {% for client in clients %}
                                <label style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-app); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;" class="client-check-label">
                                    <input type="checkbox" 
                                           class="client-checkbox-{{ advisory.id }}" 
                                           data-client-id="{{ client.id }}"
                                           value="{{ client.id }}"
                                           {% if client.id in (advisory.clients|map(attribute='id')|list) %}checked{% endif %}
                                           style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent-primary);">
                                    <span style="font-size: 12px; font-weight: 700; color: var(--text-primary);">{{ client.name }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        <button onclick="updateClients({{ advisory.id }})" class="intel-btn" style="width: 100%; padding: var(--space-md); font-size: var(--fs-sm); background: var(--bg-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary);">UPDATE CLIENTS</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="padding: 40px; text-align: center; background: var(--bg-card); border: 2px dashed var(--border); border-radius: var(--radius-lg); color: var(--text-muted);">No sent advisories</div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.client-check-label:has(input:checked) {
    background: rgba(20, 184, 166, 0.15) !important;
    border-color: var(--accent-primary) !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    document.getElementById('advisorySentDate').value = new Date().toISOString().split('T')[0];
});

function toggleClients(advisoryId) {
    const clientsDiv = document.getElementById(`clients-${advisoryId}`);
    const chevron = document.getElementById(`chevron-${advisoryId}`);
    const isVisible = clientsDiv.style.display !== 'none';
    clientsDiv.style.display = isVisible ? 'none' : 'block';
    chevron.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
}

document.getElementById('advisoryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = {
        name: document.getElementById('advisoryName').value,
        topic: document.getElementById('advisoryTopic').value,
        sent_date: document.getElementById('advisorySentDate').value,
        sent_by: 'Admin'
    };
    
    fetch('/api/advisory', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(formData)
    })
    .then(r => {
        if (!r.ok) {
            throw new Error(`HTTP error! status: ${r.status}`);
        }
        return r.json();
    })
    .then(d => {
        if (d.success) {
            showNotification('Advisory created successfully', 'success');
            // Clear form
            document.getElementById('advisoryName').value = '';
            document.getElementById('advisoryTopic').value = '';
            document.getElementById('advisorySentDate').value = new Date().toISOString().split('T')[0];
            // Reload page after short delay
            setTimeout(() => location.reload(), 800);
        } else {
            showNotification('Error: ' + (d.error || 'Unknown error'), 'error');
        }
    })
    .catch(err => {
        console.error('Error creating advisory:', err);
        showNotification('Error creating advisory: ' + err.message, 'error');
    });
});

function saveAndSend(id) {
    const clients = Array.from(document.querySelectorAll(`.client-checkbox-${id}:checked`)).map(c => parseInt(c.dataset.clientId));
    if (!clients.length) {
        showNotification('Please select at least one client', 'warning');
        return;
    }
    
    fetch(`/api/advisory/${id}/clients`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ client_ids: clients })
    })
    .then(r => {
        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
        return r.json();
    })
    .then(d => {
        if (d.success) {
            showNotification('Advisory sent successfully to ' + clients.length + ' client(s)', 'success');
            setTimeout(() => location.reload(), 800);
        } else {
            showNotification('Error: ' + (d.error || 'Unknown error'), 'error');
        }
    })
    .catch(err => {
        console.error('Error sending advisory:', err);
        showNotification('Error sending advisory: ' + err.message, 'error');
    });
}

function updateClients(id) {
    const clients = Array.from(document.querySelectorAll(`.client-checkbox-${id}:checked`)).map(c => parseInt(c.dataset.clientId));
    
    fetch(`/api/advisory/${id}/clients`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ client_ids: clients })
    })
    .then(r => {
        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
        return r.json();
    })
    .then(d => {
        if (d.success) {
            showNotification('Clients updated successfully', 'success');
            setTimeout(() => location.reload(), 800);
        } else {
            showNotification('Error: ' + (d.error || 'Unknown error'), 'error');
        }
    })
    .catch(err => {
        console.error('Error updating clients:', err);
        showNotification('Error updating clients: ' + err.message, 'error');
    });
}

function deleteAdvisory(id) {
    if (!confirm('Are you sure you want to delete this advisory?')) return;
    
    fetch(`/api/advisory/${id}`, { method: 'DELETE' })
    .then(r => {
        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
        return r.json();
    })
    .then(d => {
        showNotification('Advisory deleted successfully', 'success');
        setTimeout(() => location.reload(), 600);
    })
    .catch(err => {
        console.error('Error deleting advisory:', err);
        showNotification('Error deleting advisory: ' + err.message, 'error');
    });
}
</script>
{% endblock %}
