{% extends "base.html" %}

{% block title %}National Intelligence{% endblock %}

{% block content %}
<div class="main-content-wrapper">
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">National Intelligence</h1>
            <p class="dashboard-subtitle">Aggregated cybersecurity and regulatory advisories from CERT-In, IRDAI, and RBI.</p>
        </div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
            <button onclick="globalRefresh()" class="intel-btn-modern" style="padding: 6px 14px; font-size: 11px; min-height: 32px;">
                <i data-lucide="refresh-cw" style="width: 14px; height: 14px; margin-right: 6px;"></i>
                Global Refresh
            </button>
        </div>
    </header>

    <!-- Modern Unified Tab Navigation -->
    <div style="display: flex; gap: 2px; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); padding: 2px; margin-bottom: var(--space-lg); width: fit-content;">
        <a href="/cert" class="pro-tab-link {% if request.endpoint == 'cert' %}active{% endif %}" style="padding: 8px 20px; font-size: 11px; font-weight: var(--fw-semibold); color: {% if request.endpoint == 'cert' %}var(--text-primary){% else %}var(--text-secondary){% endif %}; background: {% if request.endpoint == 'cert' %}var(--accent-primary){% else %}transparent{% endif %}; border-radius: var(--radius-xs); text-decoration: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;">
            <i data-lucide="globe" style="width: 14px; height: 14px;"></i>
            International CERT
        </a>
        <a href="/cert-in" class="pro-tab-link {% if request.endpoint == 'cert_in' %}active{% endif %}" style="padding: 8px 20px; font-size: 11px; font-weight: var(--fw-semibold); color: {% if request.endpoint == 'cert_in' %}var(--text-primary){% else %}var(--text-secondary){% endif %}; background: {% if request.endpoint == 'cert_in' %}var(--accent-primary){% else %}transparent{% endif %}; border-radius: var(--radius-xs); text-decoration: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;">
            <i data-lucide="flag" style="width: 14px; height: 14px;"></i>
            CERT-In
        </a>
        <a href="/irdai" class="pro-tab-link {% if request.endpoint == 'irdai' %}active{% endif %}" style="padding: 8px 20px; font-size: 11px; font-weight: var(--fw-semibold); color: {% if request.endpoint == 'irdai' %}var(--text-primary){% else %}var(--text-secondary){% endif %}; background: {% if request.endpoint == 'irdai' %}var(--accent-primary){% else %}transparent{% endif %}; border-radius: var(--radius-xs); text-decoration: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;">
            <i data-lucide="shield" style="width: 14px; height: 14px;"></i>
            IRDAI
        </a>
        <a href="/rbi" class="pro-tab-link {% if request.endpoint == 'rbi' %}active{% endif %}" style="padding: 8px 20px; font-size: 11px; font-weight: var(--fw-semibold); color: {% if request.endpoint == 'rbi' %}var(--text-primary){% else %}var(--text-secondary){% endif %}; background: {% if request.endpoint == 'rbi' %}var(--accent-primary){% else %}transparent{% endif %}; border-radius: var(--radius-xs); text-decoration: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;">
            <i data-lucide="building" style="width: 14px; height: 14px;"></i>
            RBI
        </a>
        <a href="/india-govt" class="pro-tab-link {% if request.endpoint == 'india_govt' %}active{% endif %}" style="padding: 8px 20px; font-size: 11px; font-weight: var(--fw-semibold); color: {% if request.endpoint == 'india_govt' %}var(--text-primary){% else %}var(--text-secondary){% endif %}; background: {% if request.endpoint == 'india_govt' %}var(--accent-primary){% else %}transparent{% endif %}; border-radius: var(--radius-xs); text-decoration: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;">
            <i data-lucide="layers" style="width: 14px; height: 14px;"></i>
            Unified View
        </a>
    </div>

    <div style="max-width: 1100px;">
        {% for section_title, items, endpoint, name in [
            ('CERT-In Alerts', cert_in_items, '/cert-in', 'CERT-In'),
            ('IRDAI Regulatory', irdai_items, '/irdai', 'IRDAI'),
            ('RBI Directions', rbi_items, '/rbi', 'RBI')
        ] %}
        <div style="margin-bottom: 48px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                <div style="width: 4px; height: 24px; background: linear-gradient(180deg, var(--accent-primary), var(--accent-secondary)); border-radius: 2px;"></div>
                <h2 style="font-size: 16px; font-weight: 800; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.05em;">{{ section_title }}</h2>
                <a href="{{ endpoint }}" style="margin-left: auto; font-size: 12px; font-weight: 700; color: var(--accent-primary); text-decoration: none;">View All â†’</a>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: var(--space-md);">
                {% if items %}
                    {% for item in items[:5] %}
                    <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: var(--space-lg); margin-bottom: var(--space-md); transition: all 0.2s; box-shadow: var(--shadow-sm); position: relative; overflow: hidden;" onmouseover="this.style.borderColor='var(--border)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-md)'; this.style.background='var(--bg-elevated)'" onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)'; this.style.background='var(--bg-card)'">
                        <div style="display: flex; align-items: flex-start; gap: var(--space-md);">
                            <!-- Agency Icon with National Flag Colors -->
                            <div style="flex-shrink: 0;">
                                {% if item.source == 'CERT-In' %}
                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #FF9933, #FFFFFF, #138808); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-accent); border: 1px solid var(--border-subtle); position: relative; overflow: hidden;">
                                    <div style="position: absolute; inset: 0; background: radial-gradient(circle at center, rgba(255,255,255,0.3) 0%, transparent 70%);"></div>
                                    <span style="font-size: 18px; font-weight: var(--fw-bold); color: #000080; z-index: 1;">IN</span>
                                </div>
                                {% elif item.source == 'RBI' %}
                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #1E3A8A, #3B82F6); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-accent); border: 1px solid var(--border-subtle);">
                                    <span style="font-size: 16px; font-weight: var(--fw-bold); color: white; letter-spacing: 0.05em;">RBI</span>
                                </div>
                                {% elif item.source == 'IRDAI' %}
                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #059669, #10B981); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-accent); border: 1px solid var(--border-subtle);">
                                    <span style="font-size: 14px; font-weight: var(--fw-bold); color: white; letter-spacing: 0.05em;">IRDAI</span>
                                </div>
                                {% else %}
                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-accent); border: 1px solid var(--border-subtle);">
                                    <i data-lucide="file-text" style="width: 24px; height: 24px; color: white;"></i>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div style="flex: 1; min-width: 0;">
                                <!-- Header Row (Source, Date) -->
                                <div style="display: flex; align-items: center; gap: var(--space-xs); margin-bottom: var(--space-xs); flex-wrap: wrap;">
                                    <span style="font-size: var(--fs-xs); font-weight: var(--fw-bold); color: var(--accent-primary); text-transform: uppercase; letter-spacing: 0.05em;">{{ item.source or name }}</span>
                                    <span style="width: 2px; height: 2px; background: var(--border); border-radius: 50%;"></span>
                                    <span style="font-size: 10px; color: var(--text-muted); font-weight: var(--fw-medium);">{{ item.published_date|format_date }}</span>
                                </div>
                                
                                <!-- Title -->
                                <h3 style="font-size: var(--fs-base); font-weight: var(--fw-semibold); color: var(--text-primary); margin: 0 0 var(--space-xs) 0; line-height: 1.5;">
                                    <a href="{{ item.source_url or '#' }}" target="_blank" style="color: inherit; text-decoration: none;" onmouseover="this.style.color='var(--accent-primary)'" onmouseout="this.style.color='var(--text-primary)'">{{ item.title }}</a>
                                </h3>
                                
                                <!-- Description -->
                                {% if item.description %}
                                <p style="font-size: var(--fs-sm); color: var(--text-secondary); line-height: 1.6; margin-bottom: var(--space-sm); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">{{ item.description }}</p>
                                {% endif %}
                                
                                <!-- Action Buttons -->
                                {% if item.source_url %}
                                <div style="display: flex; gap: var(--space-xs); margin-top: var(--space-xs); flex-wrap: wrap;">
                                    <a href="{{ item.source_url }}" target="_blank" class="intel-btn-modern" style="padding: 6px 14px; font-size: 11px; min-height: 32px; text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
                                        <i data-lucide="external-link" style="width: 14px; height: 14px;"></i>
                                        Open Advisory
                                    </a>
                                    <button onclick="copyToClipboard('{{ item.source_url }}')" class="intel-btn-modern" style="padding: 6px 14px; font-size: 11px; min-height: 32px; background: var(--bg-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary);" onmouseover="this.style.borderColor='var(--accent-primary)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.color='var(--text-primary)'">
                                        <i data-lucide="copy" style="width: 14px; height: 14px;"></i>
                                        Copy Link
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div style="padding: 60px; text-align: center; background: linear-gradient(135deg, var(--bg-card), var(--bg-elevated)); border: 2px dashed var(--border); border-radius: var(--radius-lg);">
                        <i data-lucide="file-x" style="width: 48px; height: 48px; color: var(--text-muted); margin-bottom: 16px; opacity: 0.5;"></i>
                        <p style="color: var(--text-muted); font-size: 14px;">No records found for {{ section_title }}.</p>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => lucide.createIcons());

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('Link copied to clipboard', 'success');
    }).catch(err => {
        showNotification('Failed to copy link', 'error');
    });
}

function globalRefresh() {
    showNotification('Fetching all advisories...', 'info');
    Promise.all([
        fetch('/api/fetch/cert-in', { method: 'POST' }),
        fetch('/api/fetch/rbi', { method: 'POST' }),
        fetch('/api/fetch/irdai', { method: 'POST' })
    ]).then(responses => {
        return Promise.all(responses.map(r => r.json()));
    }).then(results => {
        const successCount = results.filter(r => r.success || r.status === 'success').length;
        if (successCount > 0) {
            showNotification(`Synchronized ${successCount} advisory sources`, 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showNotification('Failed to fetch advisories', 'error');
        }
    }).catch(e => {
        showNotification('Error: ' + e.message, 'error');
    });
}
</script>
{% endblock %}



