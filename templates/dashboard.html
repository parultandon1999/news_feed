{% extends "base.html" %}

{% block title %}Intelligence Dashboard{% endblock %}

{% block content %}
<div class="main-content-wrapper">
    <header class="dashboard-header">
        <div style="flex: 1;">
            <h1 class="dashboard-title" style="margin-bottom: 0;">Intelligence Overview</h1>
        </div>
        
        <!-- Control Bar - Redesigned Slim Modern -->
        <div class="intel-control-bar" style="display: flex; align-items: center; gap: 8px; background: transparent; border: none; padding: 0; box-shadow: none;">
            <select id="fetchCategory" class="intel-select-modern" style="padding: 4px 10px; font-size: 10px; min-height: 26px; border: 1px solid var(--border-subtle); background: var(--bg-elevated); border-radius: 6px;">
                <option value="all">All</option>
                <option value="news">News</option>
                <option value="cve">CVE</option>
                <option value="ransomware">Ransomware</option>
                <option value="cert">CERT</option>
                <option value="cert-in">CERT-In</option>
            </select>
            <select id="fetchTimeRange" class="intel-select-modern" style="padding: 4px 10px; font-size: 10px; min-height: 26px; border: 1px solid var(--border-subtle); background: var(--bg-elevated); border-radius: 6px;">
                <option value="24">24H</option>
                <option value="168">7D</option>
                <option value="720">30D</option>
                <option value="2160">90D</option>
            </select>
            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 4px 8px; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent-primary)'; this.style.background='var(--bg-sidebar)'" onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='var(--bg-elevated)'">
                <input type="checkbox" id="confirmFetch" style="cursor: pointer; width: 12px; height: 12px; accent-color: var(--accent-primary); margin: 0;">
                <span style="font-size: 9px; font-weight: var(--fw-medium); color: var(--text-secondary);">Confirm</span>
            </label>
            <button onclick="fetchContent(); return false;" class="intel-btn-modern" id="fetchContentBtn" style="padding: 4px 14px; font-size: 10px; min-height: 26px; border-radius: 6px; font-weight: var(--fw-semibold); letter-spacing: 0.03em; background: var(--accent-primary); color: white; border: none; transition: all 0.2s;" onmouseover="this.style.opacity='0.9'; this.style.transform='translateY(-1px)'" onmouseout="this.style.opacity='1'; this.style.transform='translateY(0)'">
                <i data-lucide="refresh-cw" style="width: 12px; height: 12px; margin-right: 4px; display: inline-block; vertical-align: middle;"></i>
                SYNC
            </button>
        </div>
    </header>

    <!-- News Flash Ticker -->
    <div style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-md); padding: var(--space-xs) var(--space-sm); background: linear-gradient(135deg, var(--bg-elevated), var(--bg-sidebar)); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); overflow: hidden; position: relative;">
        <div style="display: flex; align-items: center; gap: var(--space-xs); flex-shrink: 0; padding-right: var(--space-sm); border-right: 1px solid var(--border-subtle);">
            <span class="live-dot" style="width: 6px; height: 6px; background: var(--severity-critical); border-radius: 50%; display: inline-block; animation: pulse 2s ease-in-out infinite;"></span>
            <span style="font-size: 9px; color: var(--accent-primary); font-weight: var(--fw-bold); text-transform: uppercase; letter-spacing: 0.1em;">FLASH</span>
        </div>
        <div id="newsTicker" style="flex: 1; overflow: hidden; position: relative; height: 20px; display: flex; align-items: center;">
            <div id="tickerContent" style="display: flex; align-items: center; gap: var(--space-md); white-space: nowrap;">
                <!-- Ticker items will be populated by JavaScript -->
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: var(--space-xs); flex-shrink: 0; padding-left: var(--space-sm); border-left: 1px solid var(--border-subtle);">
            <span id="currentTime" style="font-size: 9px; color: var(--text-secondary); font-weight: var(--fw-medium); font-family: var(--font-mono);"></span>
            <span style="width: 1px; height: 10px; background: var(--border); margin: 0 4px;"></span>
            <span style="font-size: 9px; color: var(--text-muted); font-weight: var(--fw-normal);">Updated:</span>
            <span id="lastUpdatedTime" style="font-size: 9px; color: var(--text-muted); font-weight: var(--fw-normal); font-family: var(--font-mono);">{{ now_ist().strftime('%b %d • %I:%M:%S %p') }}</span>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-xl);">
        <a href="/news" class="bento-card" style="text-decoration: none;">
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-accent); flex-shrink: 0;">
                    <i data-lucide="newspaper" style="width: 18px; height: 18px; color: white;"></i>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 10px; font-weight: var(--fw-semibold); color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px;">News</div>
                    <div style="font-size: var(--fs-2xl); font-weight: var(--fw-bold); color: var(--text-primary); line-height: 1; letter-spacing: -0.02em;">{{ stats.category_counts.get('news', 0) }}</div>
                </div>
            </div>
        </a>
        
        <a href="/cve" class="bento-card" style="text-decoration: none;">
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3); flex-shrink: 0;">
                    <i data-lucide="shield-alert" style="width: 18px; height: 18px; color: white;"></i>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 10px; font-weight: var(--fw-semibold); color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px;">CVEs</div>
                    <div style="font-size: var(--fs-2xl); font-weight: var(--fw-bold); color: var(--text-primary); line-height: 1; letter-spacing: -0.02em;">{{ stats.category_counts.get('cve', 0) }}</div>
                </div>
            </div>
        </a>
        
        <a href="/cve?severities=CRITICAL,HIGH" class="bento-card" style="text-decoration: none;">
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--severity-critical), #dc2626); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3); flex-shrink: 0;">
                    <i data-lucide="alert-triangle" style="width: 18px; height: 18px; color: white;"></i>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 10px; font-weight: var(--fw-semibold); color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px;">High, Critical CVE</div>
                    <div style="font-size: var(--fs-2xl); font-weight: var(--fw-bold); color: var(--severity-critical); line-height: 1; letter-spacing: -0.02em;">{{ stats.critical_high }}</div>
                </div>
            </div>
        </a>
        
        <a href="/government" class="bento-card" style="text-decoration: none;">
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b, #eab308); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3); flex-shrink: 0;">
                    <i data-lucide="building-2" style="width: 18px; height: 18px; color: white;"></i>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 10px; font-weight: var(--fw-semibold); color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px;">Advisories</div>
                    <div style="font-size: var(--fs-2xl); font-weight: var(--fw-bold); color: var(--text-primary); line-height: 1; letter-spacing: -0.02em;">{{ stats.category_counts.get('cert', 0) + stats.category_counts.get('cert-in', 0) }}</div>
                </div>
            </div>
        </a>
    </div>

    <!-- Feed Grid -->
    <div class="feed-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-md);">
        <!-- News Column -->
        <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); overflow: hidden;">
            <div style="padding: var(--space-md); background: var(--bg-sidebar); border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                <h2 style="font-size: var(--fs-sm); font-weight: var(--fw-bold); color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.05em; margin: 0;">Latest News</h2>
                <a href="/news" style="font-size: 10px; font-weight: var(--fw-semibold); color: var(--accent-primary); text-decoration: none;">VIEW ALL →</a>
            </div>
            <div style="padding: var(--space-md);">
                {% set news_items = stats.latest_items.get('news', []) %}
                {% if news_items %}
                    {% for item in news_items[:6] %}
                    <div style="padding: var(--space-sm); border-left: 2px solid var(--accent-primary); background: var(--bg-elevated); border-radius: var(--radius-sm); margin-bottom: var(--space-sm); transition: all 0.2s;" onmouseover="this.style.background='var(--bg-sidebar)'" onmouseout="this.style.background='var(--bg-elevated)'">
                        <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">
                            <span style="font-size: 9px; font-weight: var(--fw-semibold); color: var(--accent-primary); text-transform: uppercase; letter-spacing: 0.05em;">{{ item.source|clean_source }}</span>
                            <span style="width: 2px; height: 2px; background: var(--border); border-radius: 50%;"></span>
                            <span style="font-size: 9px; color: var(--text-muted); font-weight: var(--fw-medium);">{{ item.published_date[:10] if item.published_date else '' }}</span>
                        </div>
                        <h3 style="font-size: var(--fs-sm); font-weight: var(--fw-semibold); color: var(--text-primary); cursor: pointer; margin: 0; line-height: 1.4; text-decoration: underline; text-decoration-color: transparent; transition: text-decoration-color 0.2s;" onclick="showArticleDetail({{ item.id }}, 'news')" onmouseover="this.style.textDecorationColor='var(--accent-primary)'" onmouseout="this.style.textDecorationColor='transparent'" title="Click to view details">{{ item.title }}</h3>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: var(--text-muted); font-size: var(--fs-sm); padding: var(--space-lg); text-align: center;">No recent news</p>
                {% endif %}
            </div>
        </div>

        <!-- CVE Column -->
        <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); overflow: hidden;">
            <div style="padding: var(--space-md); background: var(--bg-sidebar); border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                <h2 style="font-size: var(--fs-sm); font-weight: var(--fw-bold); color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.05em; margin: 0;">Vulnerabilities</h2>
                <a href="/cve" style="font-size: 10px; font-weight: var(--fw-semibold); color: var(--accent-primary); text-decoration: none;">VIEW ALL →</a>
            </div>
            <div style="padding: var(--space-md);">
                {% set cve_items = stats.latest_items.get('cve', []) %}
                {% if cve_items %}
                    {% for item in cve_items[:6] %}
                    <div style="padding: var(--space-sm); border-left: 2px solid {% if item.severity == 'CRITICAL' %}var(--severity-critical){% elif item.severity == 'HIGH' %}var(--severity-high){% elif item.severity == 'MEDIUM' %}var(--severity-medium){% else %}var(--severity-low){% endif %}; background: var(--bg-elevated); border-radius: var(--radius-sm); margin-bottom: var(--space-sm); transition: all 0.2s;" onmouseover="this.style.background='var(--bg-sidebar)'" onmouseout="this.style.background='var(--bg-elevated)'">
                        <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px; flex-wrap: wrap;">
                            {% if item.severity %}
                            <span class="severity-pill pill-{{ item.severity|lower }}" style="padding: 2px 6px; font-size: 8px;">{{ item.severity }}</span>
                            {% endif %}
                            <span style="font-size: 9px; font-weight: var(--fw-semibold); color: var(--accent-primary); text-transform: uppercase; font-family: var(--font-mono); letter-spacing: 0.05em;">{{ item.cve_id or 'CVE' }}</span>
                            <span style="width: 2px; height: 2px; background: var(--border); border-radius: 50%;"></span>
                            <span style="font-size: 9px; color: var(--text-muted); font-weight: var(--fw-medium);">{{ item.published_date[:10] if item.published_date else '' }}</span>
                        </div>
                        <a href="#" onclick="openExternalLink('{{ item.source_url or '#' }}', '{{ item.source }}'); return false;" style="font-size: var(--fs-sm); font-weight: var(--fw-semibold); color: var(--text-primary); text-decoration: none; line-height: 1.4; display: block;" onmouseover="this.style.color='var(--accent-primary)'" onmouseout="this.style.color='var(--text-primary)'">{{ item.title or (item.cve_id or 'CVE') }}</a>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: var(--text-muted); font-size: var(--fs-sm); padding: var(--space-lg); text-align: center;">No recent CVEs</p>
                {% endif %}
            </div>
        </div>

        <!-- Advisories Column -->
        <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); overflow: hidden;">
            <div style="padding: var(--space-md); background: var(--bg-sidebar); border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                <h2 style="font-size: var(--fs-sm); font-weight: var(--fw-bold); color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.05em; margin: 0;">Advisories</h2>
                <a href="/government" style="font-size: 10px; font-weight: var(--fw-semibold); color: var(--accent-primary); text-decoration: none;">VIEW ALL →</a>
            </div>
            <div style="padding: var(--space-md);">
                {% set cert_items = stats.latest_items.get('cert', []) or [] %}
                {% set certin_items = stats.latest_items.get('cert-in', []) or [] %}
                {% set advisory_items = cert_items + certin_items %}
                {% if advisory_items %}
                    {% for item in advisory_items[:6] %}
                    <div style="padding: var(--space-sm); border-left: 2px solid var(--accent-primary); background: var(--bg-elevated); border-radius: var(--radius-sm); margin-bottom: var(--space-sm); transition: all 0.2s;" onmouseover="this.style.background='var(--bg-sidebar)'" onmouseout="this.style.background='var(--bg-elevated)'">
                        <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">
                            <span style="font-size: 9px; font-weight: var(--fw-semibold); color: var(--accent-primary); text-transform: uppercase; letter-spacing: 0.05em;">{{ item.source }}</span>
                            <span style="width: 2px; height: 2px; background: var(--border); border-radius: 50%;"></span>
                            <span style="font-size: 9px; color: var(--text-muted); font-weight: var(--fw-medium);">{{ item.published_date[:10] if item.published_date else '' }}</span>
                        </div>
                        <a href="#" onclick="openExternalLink('{{ item.source_url or '#' }}', '{{ item.source }}'); return false;" style="font-size: var(--fs-sm); font-weight: var(--fw-semibold); color: var(--text-primary); text-decoration: none; line-height: 1.4; display: block;" onmouseover="this.style.color='var(--accent-primary)'" onmouseout="this.style.color='var(--text-primary)'">{{ item.title }}</a>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: var(--text-muted); font-size: var(--fs-sm); padding: var(--space-lg); text-align: center;">No recent advisories</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Progress Toast -->
<div id="progressContainer" class="progress-toast" style="display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span style="font-size: var(--fs-xs); font-weight: var(--fw-semibold); text-transform: uppercase; color: var(--accent-primary);">Syncing</span>
        <span id="progressText" style="font-size: var(--fs-xs); font-weight: var(--fw-semibold); color: var(--accent-primary);">0%</span>
    </div>
    <div style="background: var(--bg-elevated); height: 4px; border-radius: 2px; overflow: hidden; margin-bottom: 10px;">
        <div id="progressBar" style="background: var(--accent-primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
    </div>
    <div id="progressStatus" style="font-size: 10px; color: var(--text-secondary); margin-bottom: 8px;"></div>
    <button onclick="cancelFetch(); return false;" class="intel-btn" style="background: var(--bg-elevated); border: 1px solid var(--border-subtle); color: color: var(--text-secondary); width: 100%; padding: var(--space-sm); font-size: var(--fs-xs);" id="progressCancelBtn">CANCEL</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
    // Only check job status once, don't start polling unless job is running
    fetch('/api/job/status').then(r => r.json()).then(data => {
        if (data.running) {
            checkJobStatus();
            startPolling();
        }
    });
    updateCurrentTime();
    updateLastUpdatedTime();
    initNewsTicker();
    // Update time every second
    setInterval(updateCurrentTime, 1000);
});

function fetchContent() {
    const confirmFetch = document.getElementById('confirmFetch');
    if (!confirmFetch?.checked) {
        showNotification('Please check "Confirm" to proceed', 'warning');
        return;
    }
    const category = document.getElementById('fetchCategory').value;
    const hours = document.getElementById('fetchTimeRange').value;
    
    if (category === 'all') {
        // Fetch all categories with time range
        const url = `/api/fetch?hours=${hours}`;
        triggerFetch(url, null);
    } else {
        // Fetch specific category - use dedicated endpoint with hours parameter
        const url = `/api/fetch/${category}?hours=${hours}`;
        triggerFetch(url, null);
    }
}

function triggerFetch(url, body) {
    const options = { method: 'POST' };
    if (body) {
        options.headers = { 'Content-Type': 'application/json' };
        options.body = body;
    }
    document.getElementById('progressContainer').style.display = 'block';
    fetch(url, options).then(r => r.json()).then(data => {
        if (data.success !== false) {
            showNotification('Sync started', 'info');
            startPolling();
        } else {
            showNotification('Error: ' + (data.error || 'Unknown error'), 'error');
            document.getElementById('progressContainer').style.display = 'none';
        }
    }).catch(e => {
        showNotification('Error: ' + e.message, 'error');
        document.getElementById('progressContainer').style.display = 'none';
    });
}

function startPolling() {
    if (window.fetchJobPollInterval) clearInterval(window.fetchJobPollInterval);
    window.fetchJobPollInterval = setInterval(checkJobStatus, 2000);
}

function checkJobStatus() {
    fetch('/api/job/status').then(r => r.json()).then(data => {
        const container = document.getElementById('progressContainer');
        if (data.running) {
            container.style.display = 'block';
            document.getElementById('progressBar').style.width = (data.progress || 0) + '%';
            document.getElementById('progressText').textContent = (data.progress || 0) + '%';
            document.getElementById('progressStatus').textContent = data.message || 'Processing...';
            if (!window.fetchJobPollInterval) startPolling();
        } else {
            if (data.status === 'completed') {
                showNotification('Sync complete - Refreshing dashboard...', 'success');
                container.style.display = 'none';
                // Force hard reload to bypass cache
                setTimeout(() => {
                    window.location.reload(true);
                }, 1000);
            }
            if (window.fetchJobPollInterval) {
                clearInterval(window.fetchJobPollInterval);
                window.fetchJobPollInterval = null;
            }
        }
    });
}

function cancelFetch() {
    fetch('/api/job/cancel', { method: 'POST' }).then(() => {
        showNotification('Cancelled', 'info');
        document.getElementById('progressContainer').style.display = 'none';
    });
}

function updateCurrentTime() {
    const timeElement = document.getElementById('currentTime');
    if (timeElement) {
        const now = new Date();
        const options = { 
            month: 'short', 
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            second: '2-digit',
            hour12: true,
            timeZone: 'Asia/Kolkata'
        };
        const istTime = now.toLocaleString('en-US', options);
        timeElement.textContent = istTime;
    }
}

function updateLastUpdatedTime() {
    // Update last updated time display (this is set on page load from server)
    const timeElement = document.getElementById('lastUpdatedTime');
    if (timeElement) {
        // Keep the server-rendered time as last updated - it updates on page refresh
        // Format is already set by server template
    }
}

function initNewsTicker() {
    const tickerContent = document.getElementById('tickerContent');
    if (!tickerContent) {
        console.error('Ticker content element not found');
        return;
    }
    
    // Fetch latest items from API for real-time updates
    fetch('/api/stats')
        .then(r => r.json())
        .then(stats => {
            const latestNews = (stats.latest_items && stats.latest_items.news) ? stats.latest_items.news.slice(0, 5) : [];
            const latestCVEs = (stats.latest_items && stats.latest_items.cve) ? stats.latest_items.cve.slice(0, 5) : [];
            const certItems = (stats.latest_items && stats.latest_items.cert) ? stats.latest_items.cert.slice(0, 3) : [];
            const certInItems = (stats.latest_items && stats.latest_items['cert-in']) ? stats.latest_items['cert-in'].slice(0, 3) : [];
            const latestAdvisories = [...certItems, ...certInItems];
            
            const tickerItems = [];
            
            // Add news items
            latestNews.forEach(item => {
                if (item && item.title) {
                    const title = item.title.length > 75 ? item.title.substring(0, 75) + '...' : item.title;
                    tickerItems.push({
                        text: `[NEWS] ${title}`,
                        type: 'news',
                        category: 'news',
                        id: item.id,
                        url: item.source_url || '#'
                    });
                }
            });
            
            // Add critical/high CVEs
            latestCVEs.filter(cve => cve && (cve.severity === 'CRITICAL' || cve.severity === 'HIGH' || cve.severity === 'Critical' || cve.severity === 'High')).forEach(item => {
                if (item && item.cve_id) {
                    const title = item.title ? (item.title.length > 55 ? item.title.substring(0, 55) + '...' : item.title) : 'Critical vulnerability detected';
                    tickerItems.push({
                        text: `[CVE] ${item.cve_id}: ${title}`,
                        type: 'cve',
                        category: 'cve',
                        id: item.id,
                        url: item.source_url || '#'
                    });
                }
            });
            
            // Add advisories
            latestAdvisories.forEach(item => {
                if (item && item.title) {
                    const title = item.title.length > 65 ? item.title.substring(0, 65) + '...' : item.title;
                    const category = item.source === 'CERT-In' ? 'cert-in' : 'cert';
                    tickerItems.push({
                        text: `[ADVISORY] ${title}`,
                        type: 'advisory',
                        category: category,
                        id: item.id,
                        url: item.source_url || '#'
                    });
                }
            });
            
            if (tickerItems.length === 0) {
                tickerContent.innerHTML = '<span style="color: var(--text-muted); font-size: 9px;">No recent updates</span>';
                return;
            }
            
            // Create ticker elements
            const tickerHTML = tickerItems.map((item, index) => {
                const color = item.type === 'cve' ? 'var(--severity-critical)' : 
                             item.type === 'advisory' ? 'var(--accent-primary)' : 'var(--accent-primary)';
                return `
                    <a href="javascript:void(0)" onclick="openTickerItemDetail(${index})" style="text-decoration: none; color: var(--text-primary); font-size: 9px; font-weight: var(--fw-medium); display: inline-flex; align-items: center; gap: 6px; padding-right: 20px; cursor: pointer;" onmouseover="this.style.color='${color}'" onmouseout="this.style.color='var(--text-primary)'">
                        <span style="width: 4px; height: 4px; background: ${color}; border-radius: 50%; flex-shrink: 0;"></span>
                        <span>${item.text}</span>
                    </a>
                `;
            }).join('<span style="margin: 0 20px; color: var(--border); font-size: 8px;">•</span>');
            
            // Store ticker items globally for modal access
            window.tickerItems = tickerItems;
            window.tickerItemsData = {
                news: latestNews,
                cves: latestCVEs,
                advisories: latestAdvisories
            };
            
            // Duplicate content for seamless loop
            tickerContent.innerHTML = tickerHTML + '<span style="margin: 0 20px; color: var(--border); font-size: 8px;">•</span>' + tickerHTML;
            
            // Add animation if not already added
            if (!document.getElementById('tickerStyles')) {
                const style = document.createElement('style');
                style.id = 'tickerStyles';
                style.textContent = `
                    @keyframes ticker {
                        0% { transform: translateX(0); }
                        100% { transform: translateX(-50%); }
                    }
                    #tickerContent {
                        animation: ticker 90s linear infinite;
                    }
                    #tickerContent:hover {
                        animation-play-state: paused;
                    }
                `;
                document.head.appendChild(style);
            }
        })
        .catch(e => {
            console.error('Error loading ticker data:', e);
            tickerContent.innerHTML = '<span style="color: var(--text-muted); font-size: 9px;">Loading updates...</span>';
        });
}

function openTickerItemDetail(index) {
    if (!window.tickerItems || !window.tickerItems[index]) {
        console.error('Ticker item not found:', index);
        return;
    }
    
    const item = window.tickerItems[index];
    
    // If item has an ID and category, open the detail modal
    if (item.id && item.category) {
        showArticleDetail(item.id, item.category);
    } else if (item.url && item.url !== '#') {
        // Otherwise, open the URL in a new tab
        window.open(item.url, '_blank');
    } else {
        console.warn('No valid action for ticker item:', item);
    }
}
</script>

<!-- Enhanced Article Modal will be created dynamically -->

<style>
/* Enhanced modal styles are in static/style.css */
</style>

<script>

// Article Detail Modal Functions
function showArticleDetail(itemId, category = 'news') {
    // Handle both old and new calling patterns
    if (typeof itemId === 'object') {
        // Old pattern: showArticleDetail(item)
        const item = itemId;
        itemId = item.id;
        category = item.category || 'news';
    }
    
    // Fetch full article details including AI summary
    fetch(`/api/article/${itemId}?include_ai=true`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                displayEnhancedArticleModal(data.article);
            } else {
                console.error('Failed to fetch article:', data.error);
                showNotification('Failed to load article details', 'error');
            }
        })
        .catch(error => {
            console.error('Error fetching article:', error);
            showNotification('Error loading article details', 'error');
        });
}

function displayEnhancedArticleModal(item) {
    console.log('Displaying enhanced modal for item:', item); // Debug log
    
    const modal = document.createElement('div');
    modal.className = 'article-modal-backdrop';
    
    // Check AI summary status
    const hasAISummary = item.ai_summary && item.ai_summary_status === 'completed';
    console.log('Has AI summary:', hasAISummary, 'Status:', item.ai_summary_status); // Debug log
    
    // AI Summary Section
    const aiSummaryHtml = hasAISummary ? `
        <div class="ai-summary-section">
            <div class="ai-summary-header">
                <i data-lucide="brain" style="width: 20px; height: 20px;"></i>
                <h4>AI Analysis</h4>
                <span class="ai-badge">Powered by Gemini</span>
            </div>
            
            <div class="ai-summary-content">
                <div class="summary-text">
                    <h5>Summary</h5>
                    <p>${escapeHtml(item.ai_summary)}</p>
                </div>
                
                ${item.ai_key_points ? `
                <div class="key-points">
                    <h5>Key Points</h5>
                    <ul>
                        ${JSON.parse(item.ai_key_points).map(point => 
                            `<li>${escapeHtml(point)}</li>`
                        ).join('')}
                    </ul>
                </div>
                ` : ''}
                
                ${item.ai_sentiment ? `
                <div class="sentiment-analysis">
                    <span class="sentiment-label">Sentiment:</span>
                    <span class="sentiment-${item.ai_sentiment}">${escapeHtml(item.ai_sentiment)}</span>
                </div>
                ` : ''}
                
                ${item.ai_category_tags ? `
                <div class="ai-tags">
                    ${JSON.parse(item.ai_category_tags).map(tag => 
                        `<span class="ai-tag">${escapeHtml(tag)}</span>`
                    ).join('')}
                </div>
                ` : ''}
            </div>
        </div>
    ` : `
        <div class="ai-summary-pending">
            <i data-lucide="clock" style="width: 16px; height: 16px;"></i>
            <span>AI analysis pending...</span>
            <button onclick="requestAISummary(${item.id})" class="ai-request-btn">
                Generate Summary
            </button>
        </div>
    `;
    
    modal.innerHTML = `
        <div class="article-modal-content enhanced">
            <div class="article-modal-header">
                <h2>${escapeHtml(item.title || 'Untitled')}</h2>
                <button class="modal-close" onclick="closeModal(this)">&times;</button>
            </div>
            
            <div class="article-modal-body">
                <!-- Source and Date -->
                <div class="article-meta">
                    <span class="source">${escapeHtml(item.source || 'Unknown Source')}</span>
                    <span class="date">${formatDate(item.published_date)}</span>
                </div>
                
                <!-- AI Summary Section -->
                ${aiSummaryHtml}
                
                <!-- Original Content -->
                <div class="original-content">
                    <h4>Full Article</h4>
                    <div class="article-description">
                        ${escapeHtml(item.description || item.meta_description || 'No description available')}
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="article-actions">
                    ${item.source_url ? `
                        <button onclick="openExternalLink('${escapeHtml(item.source_url)}', '${escapeHtml(item.source || 'External Source')}')" 
                                class="primary-btn">
                            <i data-lucide="external-link"></i>
                            Read Full Article
                        </button>
                    ` : ''}
                    
                    <button onclick="shareArticle(${item.id})" class="secondary-btn">
                        <i data-lucide="share-2"></i>
                        Share
                    </button>
                    
                    <button onclick="bookmarkArticle(${item.id})" class="secondary-btn">
                        <i data-lucide="bookmark"></i>
                        Bookmark
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
    
    // Add click outside to close
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal(modal.querySelector('.modal-close'));
        }
    });
}

function requestAISummary(articleId) {
    console.log('Requesting AI summary for article:', articleId); // Debug log
    
    fetch(`/api/ai/summarize/${articleId}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            console.log('AI summary request response:', data); // Debug log
            if (data.success) {
                showNotification('AI summary requested. Processing...', 'info');
                // Refresh modal after a delay
                setTimeout(() => {
                    // Close current modal and reopen with updated data
                    const currentModal = document.querySelector('.article-modal-backdrop');
                    if (currentModal) {
                        currentModal.remove();
                    }
                    // Reopen the modal with fresh data
                    showArticleDetail(articleId, 'news');
                }, 3000);
            } else {
                showNotification('Failed to request AI summary: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error requesting AI summary:', error);
            showNotification('Error requesting AI summary', 'error');
        });
}

function closeModal(button) {
    const modal = button.closest('.article-modal-backdrop');
    if (modal) {
        modal.remove();
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    } catch (e) {
        return dateString;
    }
}

function shareArticle(articleId) {
    if (navigator.share) {
        navigator.share({
            title: 'Security Intelligence Article',
            url: window.location.href
        });
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(window.location.href);
        showNotification('Article URL copied to clipboard', 'success');
    }
}

function bookmarkArticle(articleId) {
    // You can implement bookmarking functionality here
    showNotification('Bookmark feature coming soon!', 'info');
}

function getTimeAgo(date) {
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (minutes < 1) return 'just now';
    if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    if (days < 7) return `${days} day${days > 1 ? 's' : ''} ago`;
    return '';
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Close enhanced modal on Escape key
document.addEventListener('keydown', (e) => {
    const modal = document.querySelector('.article-modal-backdrop');
    if (modal && e.key === 'Escape') {
        modal.remove();
    }
});
</script>

{% endblock %}
